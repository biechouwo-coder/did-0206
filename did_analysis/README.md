# 基于PSM的DID分析

## 📋 分析概述

本文件夹包含基于PSM匹配结果进行双重差分（DID）分析的完整代码和结果。

### 分析流程

1. **读取PSM匹配结果** - 从2009年基期PSM匹配中获取73对匹配城市
2. **构造面板数据集** - 提取这些城市在2007-2023年所有年份的观测值
3. **设定DID变量** - 定义treat（组别）、post（时间）、did（交互项）
4. **平行趋势检验** - 绘制趋势图和事件研究法，验证平行趋势假设
5. **DID回归分析** - 估计政策的净效应

## 🎯 关键变量

### DID核心变量

- **treat**: 处理组虚拟变量
  - 1 = 试点城市（处理组）
  - 0 = 非试点城市（对照组）

- **post**: 时间虚拟变量
  - 1 = 政策实施后（2009年及以后）
  - 0 = 政策实施前（2007-2008年）

- **did**: 交互项 = treat × post
  - DID模型的核心解释变量
  - 其系数衡量政策的净效应

### 因变量

- **碳排放**: 各城市的碳排放量（或其他相关指标）

## 🚀 使用方法

### 方法1: 一键运行（推荐）

双击运行 `run_did_analysis.bat` 文件

### 方法2: 命令行运行

```bash
cd c:\Users\HP\Desktop\did-0206\did_analysis
py 01_construct_panel_and_did.py
```

## 📁 文件说明

### 脚本文件

- **01_construct_panel_and_did.py** - 主分析脚本
  - 读取PSM匹配结果
  - 构造面板数据
  - 执行平行趋势检验
  - 生成分析报告

- **run_did_analysis.bat** - 一键运行脚本

### 输出文件

运行后将生成以下文件：

#### 数据文件

1. **panel_data_2007_2023.xlsx** - 面板数据集
   - 包含所有匹配城市在2007-2023年的观测
   - 包含DID核心变量（treat, post, did）
   - 可直接用于后续DID回归

#### 图表文件

2. **parallel_trend_plot.png** - 平行趋势检验图
   - 展示处理组和对照组在2007-2023年的碳排放趋势
   - 2009年用绿色虚线标注政策实施时点
   - **关键判断**: 2009年之前两组趋势应基本平行

3. **event_study_plot.png** - 事件研究法图
   - 展示政策实施前后各年的动态处理效应
   - 包含95%置信区间
   - **关键判断**: 政策实施前的系数应不显著（包含0）

#### 报告文件

4. **did_analysis_report.txt** - 详细分析报告
   - 数据构造说明
   - DID模型设定
   - 描述性统计
   - 平行趋势检验结论
   - 后续分析建议

## 🔍 平行趋势检验

### 重要性

平行趋势假设是DID模型成立的核心前提。只有满足这一假设，DID估计的政策效应才具有因果解释力。

### 检验方法

#### 1. 趋势图检验（直观判断）

查看 `parallel_trend_plot.png`：
- **✓ 通过**: 2009年之前，处理组和对照组的碳排放趋势基本平行
- **✗ 不通过**: 2009年之前，两组趋势存在明显发散

#### 2. 事件研究法（统计检验）

查看 `event_study_plot.png` 和分析报告：
- **✓ 通过**: 政策实施前（相对年份<0）的系数均不显著（p值>0.1）
- **✗ 不通过**: 政策实施前部分年份的系数显著

### 如果不满足平行趋势

如果平行趋势假设不成立，可以考虑：

1. **调整匹配变量** - 重新运行PSM，增加或调整匹配变量
2. **缩短时间窗口** - 仅使用政策前1-2年的数据
3. **使用其他方法** - 考虑合成控制法（SCM）、事件研究法等
4. **加入控制变量** - 在DID回归中加入其他控制变量

## 📊 DID模型设定

### 基础模型

```
Y_it = α + β·did_it + γ·treat_i + δ·post_t + ε_it
```

其中：
- Y_it: 城市i在年份t的碳排放
- did_it: treat_i × post_t 交互项
- β: 政策净效应（核心关注的系数）

### 扩展模型

可以加入控制变量：

```
Y_it = α + β·did_it + γ·treat_i + δ·post_t + θ·X_it + λ_i + τ_t + ε_it
```

其中：
- X_it: 控制变量（如GDP、人口、产业结构等）
- λ_i: 城市固定效应
- τ_t: 年份固定效应

## 📈 后续分析建议

### 1. 基础DID回归
使用 `panel_data_2007_2023.xlsx` 进行OLS回归

### 2. 固定效应模型
加入城市固定效应和年份固定效应，控制不可观测因素

### 3. 稳健性检验
- 安慰剂检验：随机分配政策时点或处理组
- 排除特定样本：排除极端值或特定地区
- 改变时间窗口：使用不同的政策前后时期

### 4. 异质性分析
- 按地区分组（东中西）
- 按城市规模分组
- 按经济发展水平分组

### 5. 机制分析
探索政策影响碳排放的传导机制

## ⚠️ 注意事项

1. **数据质量**
   - 确保所有匹配城市有完整的年份数据
   - 检查异常值和缺失值

2. **假设检验**
   - 必须先通过平行趋势检验
   - 检查其他DID假设（如SUTVA等）

3. **模型选择**
   - 根据数据特征选择合适的模型
   - 考虑异方差和序列相关问题

4. **结果解释**
   - DID系数是平均处理效应（ATE）
   - 注意因果推断的限制条件

## 📦 依赖库

- pandas
- numpy
- matplotlib
- statsmodels（用于事件研究法）
- openpyxl（读取Excel）

安装缺失库：
```bash
pip install statsmodels openpyxl
```

## 📞 技术支持

如有问题，请检查：
1. PSM匹配结果文件是否存在
2. 原始数据文件路径是否正确
3. Python环境和依赖库是否完整

---

**生成时间**: 2026-02-06
**基于PSM**: psm_analysis_2009
**匹配城市**: 73对（146个）
**分析期间**: 2007-2023
**政策时点**: 2009年
