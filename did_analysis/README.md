# 基于PSM的DID分析

## ⚠️ 重要修正（2026-02-06）

**问题发现**：初始版本仅"检查"treat变量是否存在，未基于PSM匹配结果显式生成DID变量，存在逻辑漏洞。

**修正方案**：
1. ✅ 从PSM匹配结果中**显式提取**处理组城市列表（73个）
2. ✅ 基于PSM结果在面板数据中**重新生成**treat变量
3. ✅ 根据年份生成post变量（2009年及以后=1）
4. ✅ 计算did交互项（treat × post）
5. ✅ 对比原始变量（如存在），确保数据一致性

**核心逻辑**：
```python
# 从PSM匹配结果中提取处理组城市
psm_treat_cities = df_psm[df_psm['treat'] == 1]['city_name'].tolist()

# 在面板数据中重新生成treat变量
df_panel['treat_new'] = df_panel['city_name'].isin(psm_treat_cities).astype(int)

# 生成post和did变量
df_panel['post_new'] = (df_panel['year'] >= 2009).astype(int)
df_panel['did_new'] = df_panel['treat_new'] * df_panel['post_new']
```

**验证结果**：
- ✅ 新生成的treat变量与原始treat变量完全一致
- ✅ 平行趋势假设成立（t统计量=0.711, p>0.05）
- ✅ 所有146个城市都有完整的17年数据

## 📋 分析概述

本文件夹包含基于PSM匹配结果进行双重差分（DID）分析的完整代码和结果。

### 分析流程

1. **读取PSM匹配结果** - 从2009年基期PSM匹配中获取73对匹配城市
2. **构造面板数据集** - 提取这些城市在2007-2023年所有年份的观测值
3. **设定DID变量** - 定义treat（组别）、post（时间）、did（交互项）
4. **平行趋势检验** - 绘制趋势图和事件研究法，验证平行趋势假设
5. **DID回归分析** - 估计政策的净效应

## 🎯 关键变量

### DID核心变量

- **treat**: 处理组虚拟变量
  - 1 = 试点城市（处理组）
  - 0 = 非试点城市（对照组）

- **post**: 时间虚拟变量
  - 1 = 政策实施后（2009年及以后）
  - 0 = 政策实施前（2007-2008年）

- **did**: 交互项 = treat × post
  - DID模型的核心解释变量
  - 其系数衡量政策的净效应

### 因变量

- **碳排放**: 各城市的碳排放量（或其他相关指标）

## 🚀 使用方法

### 方法1: 一键运行（推荐）

双击运行 `run_did_analysis.bat` 文件

### 方法2: 命令行运行

```bash
cd c:\Users\HP\Desktop\did-0206\did_analysis
py 02_reconstruct_did_vars.py
```

## 📁 文件说明

### 脚本文件

- **02_reconstruct_did_vars.py** - DID分析主脚本（修正版）
  - 从PSM匹配结果中显式提取处理组城市
  - 基于PSM结果重新生成treat、post、did变量
  - 执行平行趋势检验（包含斜率统计检验）
  - 生成验证报告

- **run_did_analysis.bat** - 一键运行脚本

### 输出文件

运行后将生成以下文件：

#### 数据文件

1. **panel_data_2007_2023_corrected.xlsx** - 面板数据集（修正版）
   - 包含所有匹配城市在2007-2023年的观测
   - DID变量基于PSM匹配结果显式生成
   - 可直接用于后续DID回归
   - 文件大小：528KB

#### 图表文件

2. **parallel_trend_plot_psm_based.png** - 平行趋势检验图（全期）
   - 展示处理组和对照组在2007-2023年的碳排放趋势
   - 2009年用绿色虚线标注政策实施时点
   - 标注"基于PSM匹配结果"
   - **关键判断**: 2009年之前两组趋势应基本平行
   - 文件大小：280KB

3. **parallel_trend_pre_policy_psm_based.png** - 政策前趋势放大图
   - 专门展示2007-2008年的趋势
   - 包含斜率计算和统计检验
   - **判断标准**: 斜率差异的t统计量应小于临界值（4.303）
   - 当前结果：t=0.711，平行趋势假设成立 ✓
   - 文件大小：246KB
   - 包含95%置信区间
   - **关键判断**: 政策实施前的系数应不显著（包含0）

#### 报告文件

4. **did_variable_verification_report.txt** - 验证报告
   - PSM匹配结果说明
   - DID变量生成过程（关键步骤）
   - 数据验证结果
   - 平行趋势统计检验
   - 文件大小：2.2KB

## 🔍 平行趋势检验

### 重要性

平行趋势假设是DID模型成立的核心前提。只有满足这一假设，DID估计的政策效应才具有因果解释力。

### 检验方法

#### 1. 趋势图检验（直观判断）

查看 `parallel_trend_plot_psm_based.png`：
- **✓ 通过**: 2009年之前，处理组和对照组的碳排放趋势基本平行
- **✗ 不通过**: 2009年之前，两组趋势存在明显发散

#### 2. 斜率检验（统计检验）

查看 `parallel_trend_pre_policy_psm_based.png` 和验证报告：

**检验方法**：
- 计算处理组在2007-2008年的斜率（β1）
- 计算对照组在2007-2008年的斜率（β0）
- 检验 H0: β1 = β0

**判断标准**：
- **✓ 通过**: t统计量 < 临界值（4.303），无法拒绝斜率相等的假设
- **✗ 不通过**: t统计量 ≥ 临界值，拒绝斜率相等的假设

**当前结果**：
- 处理组斜率：709,633
- 对照组斜率：416,874
- 斜率差异：292,759
- t统计量：0.711
- **结论**：✓ 平行趋势假设成立（p>0.05）

**优势**：相比事件研究法，斜率检验更直接地检验了"趋势平行"这一核心假设。

### 如果不满足平行趋势

如果平行趋势假设不成立，可以考虑：

1. **调整匹配变量** - 重新运行PSM，增加或调整匹配变量
2. **缩短时间窗口** - 仅使用政策前1-2年的数据
3. **使用其他方法** - 考虑合成控制法（SCM）、事件研究法等
4. **加入控制变量** - 在DID回归中加入其他控制变量

## 📊 DID模型设定

### 基础模型

```
Y_it = α + β·did_it + γ·treat_i + δ·post_t + ε_it
```

其中：
- Y_it: 城市i在年份t的碳排放
- did_it: treat_i × post_t 交互项
- β: 政策净效应（核心关注的系数）

### 扩展模型

可以加入控制变量：

```
Y_it = α + β·did_it + γ·treat_i + δ·post_t + θ·X_it + λ_i + τ_t + ε_it
```

其中：
- X_it: 控制变量（如GDP、人口、产业结构等）
- λ_i: 城市固定效应
- τ_t: 年份固定效应

## 📈 后续分析建议

### 1. 基础DID回归
使用 `panel_data_2007_2023.xlsx` 进行OLS回归

### 2. 固定效应模型
加入城市固定效应和年份固定效应，控制不可观测因素

### 3. 稳健性检验
- 安慰剂检验：随机分配政策时点或处理组
- 排除特定样本：排除极端值或特定地区
- 改变时间窗口：使用不同的政策前后时期

### 4. 异质性分析
- 按地区分组（东中西）
- 按城市规模分组
- 按经济发展水平分组

### 5. 机制分析
探索政策影响碳排放的传导机制

## ⚠️ 注意事项

1. **数据质量**
   - 确保所有匹配城市有完整的年份数据
   - 检查异常值和缺失值

2. **假设检验**
   - 必须先通过平行趋势检验
   - 检查其他DID假设（如SUTVA等）

3. **模型选择**
   - 根据数据特征选择合适的模型
   - 考虑异方差和序列相关问题

4. **结果解释**
   - DID系数是平均处理效应（ATE）
   - 注意因果推断的限制条件

## 📦 依赖库

- pandas
- numpy
- matplotlib
- statsmodels（用于事件研究法）
- openpyxl（读取Excel）

安装缺失库：
```bash
pip install statsmodels openpyxl
```

## 📞 技术支持

如有问题，请检查：
1. PSM匹配结果文件是否存在
2. 原始数据文件路径是否正确
3. Python环境和依赖库是否完整

---

**生成时间**: 2026-02-06
**基于PSM**: psm_analysis_2009
**匹配城市**: 73对（146个）
**分析期间**: 2007-2023
**政策时点**: 2009年
